= Message Logging
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

[width="100%", cols="5,15"]
|===
>s| Policy name | Message Logging
>s|Summary      | Logs custom messages using information from incoming requests, responses from the backend, or information from other policies applied to the same API endpoint.
>s|Category | Troubleshooting
>s|First Mule version available | v3.8.0
.1+>.^s| Returned Status Codes
| No return codes exist for this policy
|===

The Message Logging policy logs custom messages using information from incoming requests, responses from the backend, or information from other policies applied to the same API endpoint. 

This policy works with both Apache log4j and Apache log4j2.

== Prerequisites

You must have the Anypoint Platform Organization Administrators role or have permission to create or manage APIs.

== How This Policy Works

Logging a policy consists of the following sequence:

. A request is sent to the API.
. The message is logged if the following conditions are true:
** The level and category of the log defined in the policy are included in the logger defined in the log4j2.xml configuration file.
** Either the conditional field of the policy was not set, or was set and the condition was met.
. The API response is returned. Message Logging Policy does not interfere with the execution of any policy nor its flow.
. The message appears in the application log.

== About the Logging Format

A message log uses the following format: 

`<date> <thread name> <level> <category>: <message>`

`date` is the message logging date and timestamp.

`thread name` is the name of the event thread in which the message appears.

`level` is the logging level or type of the message, such as INFO, WARN, ERROR, and DEBUG (log4j level).

For more information, see https://www.tutorialspoint.com/log4j/log4j_logging_levels.htm[log4j Logging Levels].

`category` typically indicates the package and class where the logging occurred. The default value is `org.mule.runtime.logging.policy-<policy id>`.

`message`: displays the message to be logged, for example, `the payload`:

`2018-01-25 18:57:29,907 [WrapperListener_start_runner] INFO org.mule: the payload`

== Logging States During Events

Message logging occurs at specific intervals during a request flow:

* Before logging an API flow:
+
image::apim-message-logging-policy-states-1.png[State before logging an API flow]
* After logging an API flow:
+
image::apim-message-logging-policy-states-2.png[State after logging an API flow]
* Error handler after API flow:
+
image::apim-message-logging-policy-states-3.png[State after the error handler executes]


== Configuring Policy Parameters

When you use the UI to apply the Message Logging policy to your API, you can configure the following parameters:

image::apim-message-logging-policy-ui.png[Message Logging Policy UI]

[%header%autowidth.spread]
|===
|Parameter |Description | Required?
|Message |A DataWeave expression to use for extracting the message to be logged
Note: If the payload is used as part of the message log, do not configure the Listener as nonrepeatable.|Required
|Conditional |A DataWeave Boolean expression used to specify whether a message is to be logged |Optional
|Category |A prefix in the log message that indicates the package and class where the log is executed. If no category is set, the default value is `org.mule.runtime.logging.policy-<policy id>`. |Optional
|Level |Defines the level of message to log: INFO, WARN, ERROR, or DEBUG |Required
|Before Calling API |Set to cause your logging policy to log messages before the API endpoint is called, taking into account the order in which this policy is applied |Optional
|After Calling API |Set to cause your logging policy to log messages after the API endpoint is called, taking into account the order in which this policy is applied |Optional
|===

== Example of Message Logging Policy Configured from the UI

To better understand how to use the Message Logging policy, consider the "Les Vetments" company that is in the business of retail clothing and more. To run their e-commerce portal successfully, Les Vetments needs to audit the status code of the requests made on their website.

For example, if a customers buys or returns a product, or if the company adds or removes a product from the catalogue, the transactions must be logged. The IT manager at Les Vetments applies the Message Logging policy to their APIs to enable logging and viewing any data or transaction changes without making any modifications in the code.

To log the status code of the API response that is being returned to the calling client application, Les Vetments applies the Message Logging policy to the API with the following UI configurations:

* *Message*: #[“Status code of the response is: ” ++ attributes.statusCode]

Everything in the payload must be logged.
* *Conditional*: Blank

Because Les Vetments requires all types of messages, no Mule expression to filter messages is specified.
* *Category*: Blank

No prefix is required in the log sentence.
* *Level*: Info

All types of messages are to be logged: Info, Warn, Error, or Debug.
* *Before Calling API*: Checked

All transactions occurring before the API is called is to be logged.
* *After calling API*: Checked

All transactions occurring after the API is called is to be logged.

Now, whenever a customer accesses the Les Vetments catalogue, adds or removes items from their cart, or when an item is added or removed from the catalogue, logs are generated:

[source,text,linenums]
----
**********************************************************************
* Policy: message-logging-1351146-proxy                              *
* OS encoding: UTF-8, Mule encoding: UTF-8                           *
*                                                                    *
**********************************************************************
12:18:31.770     11/18/2020     Worker-0     agw-policy-set-deployment.01     INFO
Applied policy message-logging-1351146 version 1.0.0 to API testLoggingNew-v1-v1:16481163 (16481163) in application messagelog
12:18:32.577     11/18/2020     Worker-0     [MuleRuntime].uber.29: [messagelog].proxy.CPU_LITE @29ec8fb0     INFO
event:3abc7ce0-29db-11eb-8679-02d69ee6cf38 Status code of the response is: 204
----

If you want to log headers, use the following code snippet in the *Message* field:

`#[attributes.headers]`

If you want to customize the log messages based on the event and the action performed, use the following code snippet in the *Message* field:

`#['User ' ++ authentication.clientId ++ ' performed action ' ++ attributes.method ++ ' on ' ++ attributes.requestPath ++ ' with Payload: ' ++ payload]`


== Example of Message Logging Policy Configured in XML

The following flow shows an example logging policy:

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:http-policy="http://www.mulesoft.org/schema/mule/http-policy"
      xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core
      http://www.mulesoft.org/schema/mule/core/current/mule.xsd
      http://www.mulesoft.org/schema/mule/http-policy
      http://www.mulesoft.org/schema/mule/http-policy/current/mule-http-policy.xsd">

<http-policy:proxy name="102280-message-logging">
  <http-policy:source>
   <try>
	<try>
	  <logger level="INFO" message="#[payload]"
	  category="org.mule.runtime.logging.policy-102280"/>
	    <error-handler>
	     <on-error-continue>
		<logger level="DEBUG" message="Before calling API turned into an error"
			category="org.mule.runtime.logging.policy-102280"/>
	     </on-error-continue>
	    </error-handler>
	</try>
        <http-policy:execute-next/>
          <error-handler>
	    <on-error-propagate logException="false">
	    </on-error-propagate>
          </error-handler>
  </try>
  </http-policy:source>
</http-policy:proxy>
</mule>
----

== See Also

* https://forums.mulesoft.com[MuleSoft Forum]
* https://help.mulesoft.com[Contact MuleSoft Support]
* xref:mule-runtime::intro-mule-message[Mule Messages in Mule 4]